---
// Newsletter Page - Content-driven with functional form
import Layout from "../layouts/Layout.astro";
import Hero from "../components/Hero.astro";
import { siteContent } from '@/content';

const { newsletter } = siteContent.pages;
---

<Layout
    title="Newsletter - CoderDojo Schöneweide"
    description="Melde Dich zum eMail-Newsletter des CoderDojo Schöneweide an, um regelmäßig über bevorstehende Workshops informiert zu werden."
>
    <Hero hero={newsletter.hero} />

    <!-- Newsletter Form Section -->
    <section class="py-20 bg-white dark:bg-slate-900">
        <div class="container mx-auto px-6">
            <div class="max-w-2xl mx-auto">
                <div
                    class="bg-slate-50 dark:bg-slate-800 rounded-lg p-8 shadow-lg"
                >
                    <form class="newsletter space-y-6">
                        <!-- Email Input -->
                        <div>
                            <label
                                class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
                            >
                                {newsletter.form.description}
                                <input
                                    type="email"
                                    name="email"
                                    placeholder={newsletter.form
                                        .emailPlaceholder}
                                    class="mt-2 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-slate-900 dark:text-slate-100 placeholder-slate-400 focus:outline-hidden focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                                    required
                                />
                            </label>
                            <p
                                class="mt-1 text-sm text-slate-500 dark:text-slate-400"
                            >
                                {newsletter.form.emailHint}
                            </p>
                        </div>

                        <!-- Privacy Policy Checkbox -->
                        <div>
                            <label class="flex items-start space-x-3">
                                <input
                                    type="checkbox"
                                    name="accept-privacy-policy"
                                    class="mt-1 h-4 w-4 text-primary-600 focus:ring-primary-500 border-slate-300 dark:border-slate-600 rounded"
                                    required
                                />
                                <span
                                    class="text-sm text-slate-700 dark:text-slate-300"
                                >
                                    {newsletter.form.privacyLabel}
                                </span>
                            </label>
                            <p
                                class="mt-2 text-sm text-slate-500 dark:text-slate-400"
                            >
                                {newsletter.form.privacyHint}
                            </p>
                        </div>

                        <!-- Brevo Privacy Notice -->
                        <div
                            class="text-sm text-slate-600 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 p-4 rounded"
                        >
                            <p>
                                Wir verwenden Brevo als unsere
                                Marketing-Plattform. Indem du das Formular
                                absendest, erklärst du dich einverstanden, dass
                                die von dir angegebenen persönlichen
                                Informationen an Brevo zur Bearbeitung
                                übertragen werden gemäß den
                                <a
                                    href={newsletter.form.privacyLink.url}
                                    class="text-primary-600 dark:text-primary-300 underline hover:text-primary-700 dark:hover:text-primary-200"
                                    target="_blank"
                                    rel="noopener"
                                >
                                    {newsletter.form.privacyLink.text}
                                </a>.
                            </p>
                        </div>

                        <!-- Captcha Placeholder -->
                        <div
                            id="captcha-container"
                            class="p-4 bg-slate-100 dark:bg-slate-700 rounded-sm border-2 border-dashed border-slate-300 dark:border-slate-600 text-center"
                        >
                            <p
                                class="text-sm text-slate-600 dark:text-slate-400"
                            >
                                Captcha wird geladen...
                            </p>
                        </div>

                        <!-- Submit Button -->
                        <button
                            type="submit"
                            class="w-full bg-primary-600 text-white px-6 py-3 rounded-md font-semibold hover:bg-primary-700 focus:outline-hidden focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            disabled
                        >
                            {newsletter.form.submitButton}
                        </button>
                    </form>

                    <!-- Success Message -->
                    <div
                        id="confirmation"
                        class="hidden mt-6 p-4 bg-accent-50 dark:bg-accent-900/20 border border-accent-200 dark:border-accent-800 rounded-md"
                    >
                        <div class="flex">
                            <svg
                                class="h-5 w-5 text-accent-400 mt-0.5 fill-current"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <p
                                class="ml-3 text-sm text-accent-700 dark:text-accent-300"
                            >
                                {newsletter.form.confirmationMessage}
                            </p>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div
                        id="error"
                        class="hidden mt-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md"
                    >
                        <div class="flex">
                            <svg
                                class="h-5 w-5 text-red-400 mt-0.5 fill-current"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <p
                                class="ml-3 text-sm text-red-700 dark:text-red-300"
                                id="error-text"
                            >
                                {newsletter.form.errorMessage}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</Layout>

<script>
    // Newsletter form functionality with proper typing
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector(
            "form.newsletter",
        ) as HTMLFormElement;
        const submit = form?.querySelector(
            "button[type='submit']",
        ) as HTMLButtonElement;
        const email = form?.querySelector('[name="email"]') as HTMLInputElement;
        const privacyPolicy = form?.querySelector(
            '[name="accept-privacy-policy"]',
        ) as HTMLInputElement;
        const captchaContainer = document.querySelector(
            "#captcha-container",
        ) as HTMLElement;

        let captchaCompleted = false;

        // Simple captcha simulation (replace with real captcha in production)
        if (captchaContainer) {
            setTimeout(() => {
                captchaContainer.innerHTML = `
                    <div class="flex items-center justify-center space-x-3">
                        <input type="checkbox" id="simple-captcha" class="h-4 w-4 text-primary-600">
                        <label for="simple-captcha" class="text-sm text-slate-700 dark:text-slate-300">Ich bin kein Roboter</label>
                    </div>
                `;

                const captchaCheck = captchaContainer.querySelector(
                    "#simple-captcha",
                ) as HTMLInputElement;
                captchaCheck?.addEventListener("change", () => {
                    captchaCompleted = captchaCheck.checked;
                    handleSubmitButtonState();
                });
            }, 1000);
        }

        function showError(error: any, code?: string) {
            const errors: Record<string, string> = {
                "captcha-not-verified":
                    "Beim Lösen des Captchas ist ein Fehler aufgetreten. Bitte lade die Seite neu und versuche es erneut.",
                "privacy-policy-not-accepted":
                    "Die Datenschutzerklärung muss akzeptiert werden. Bitte lade die Seite neu und versuche es erneut.",
                "missing-email":
                    "Es wurde keine E-Mail-Adresse angegeben. Bitte lade die Seite neu, gebe eine E-Mail-Adresse ein und versuche es erneut.",
            };
            const message = code
                ? errors[code]
                : "Ein unbekannter Fehler ist aufgetreten.";
            console.error(error);

            if (form) (form as HTMLElement).style.display = "none";

            const errorElement = document.querySelector(
                "#error",
            ) as HTMLElement;
            const errorText = document.querySelector(
                "#error-text",
            ) as HTMLElement;
            if (message && errorText) {
                errorText.textContent = message;
            }
            if (errorElement) errorElement.classList.remove("hidden");
        }

        function handleSubmitButtonState() {
            if (submit && email && privacyPolicy) {
                submit.disabled =
                    !privacyPolicy.checked ||
                    !captchaCompleted ||
                    !email.value.trim();
            }
        }

        // Event listeners
        if (email) email.addEventListener("input", handleSubmitButtonState);
        if (privacyPolicy)
            privacyPolicy.addEventListener("change", handleSubmitButtonState);

        if (form && submit) {
            form.addEventListener("submit", (event) => {
                event.preventDefault();
                submit.disabled = true;
                submit.textContent = "Anmeldung wird verarbeitet...";

                const formData = new FormData(event.target as HTMLFormElement);
                const data: Record<string, string> = {};

                formData.forEach((value, key) => {
                    data[key] = value.toString();
                });

                fetch("https://auth.kaes3kuch3n.de/newsletter", {
                    method: "POST",
                    body: new URLSearchParams(data).toString(),
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                })
                    .then((response) => {
                        if (response.ok) {
                            (form as HTMLElement).style.display = "none";
                            const confirmation = document.querySelector(
                                "#confirmation",
                            ) as HTMLElement;
                            if (confirmation)
                                confirmation.classList.remove("hidden");
                        } else {
                            response
                                .text()
                                .then((code) =>
                                    showError(
                                        `${response.statusText} - ${code}`,
                                        code,
                                    ),
                                );
                        }
                    })
                    .catch((error) => {
                        showError(error);
                    });
            });
        }
    });
</script>

<style>
    /* Newsletter form specific styles */
    .newsletter input[type="email"]:focus,
    .newsletter input[type="checkbox"]:focus {
        outline: 2px solid rgb(59 130 246);
        outline-offset: 2px;
    }

    .frc-captcha {
        margin: 1rem 0;
    }
</style>
