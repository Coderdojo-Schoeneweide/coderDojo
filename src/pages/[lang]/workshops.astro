---
import Layout from "../../layouts/Layout.astro";
import Hero from "../../components/Hero.astro";
import WorkshopGridIsland from "../../components/islands/WorkshopGridIsland.jsx";
import { getCollection } from "astro:content";
import { getContent } from "../../content";
import {
    getLanguageFromUrl,
    supportedLanguages,
    defaultLanguage,
} from "../../content/i18n";

// Get language from URL
const { lang } = Astro.params;
const currentLang = lang || defaultLanguage;
const content = getContent(currentLang as any);
const { workshops: workshopsPageContent } = content.pages;

// Get all workshops and sort by weight
const workshops = await getCollection("workshops", ({ id }: { id: string }) => {
    // Filter out common.md
    return id !== "common";
});

// Sort workshops by weight (if available) then by title
workshops.sort((a: any, b: any) => {
    const weightA = a.data.weight ?? 999;
    const weightB = b.data.weight ?? 999;
    if (weightA !== weightB) return weightA - weightB;
    return a.data.title.localeCompare(b.data.title);
});

// Transform workshops data for the island component
const workshopsData = workshops.map((workshop: any) => ({
    id: workshop.slug,
    title: workshop.data.title,
    description: workshop.data.description,
    duration: workshop.data.duration,
    age: workshop.data.age,
    tags: workshop.data.tags,
    image: `/workshops/${workshop.slug}/${workshop.data.image}`,
    prevKnowledge:
        workshop.data.prevKnowledge ||
        (currentLang === "ar"
            ? "غير محدد"
            : currentLang === "en"
              ? "Not specified"
              : "Nicht angegeben"),
    content: workshop.body, // Markdown content
    folder: workshop.slug, // For the modal system
}));

const heroContent = workshopsPageContent.hero;

// Export for static generation of language routes
export function getStaticPaths() {
    return supportedLanguages
        .filter((lang) => lang !== defaultLanguage)
        .map((lang) => ({
            params: { lang },
        }));
}
---

<Layout
    title={`${currentLang === "ar" ? "ورش العمل" : currentLang === "en" ? "Workshops" : "Workshops"} - CoderDojo Schöneweide`}
    description={content.site.description}
>
    <Hero hero={heroContent} />

    <!-- Workshop Grid Section -->
    <section
        class="py-20 bg-white dark:bg-gray-900 text-accent-900 dark:text-gray-100"
        dir={currentLang === "ar" ? "rtl" : "ltr"}
    >
        <div class="container mx-auto px-6">
            <WorkshopGridIsland workshops={workshopsData} client:load />
        </div>
    </section>
</Layout>
